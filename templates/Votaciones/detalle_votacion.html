<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sala de Votaci√≥n</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: sans-serif; background-color: #f4f7f6; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .estado-box { float: right; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9em; }
        .activa { background: #d4edda; color: #155724; }
        .cerrada { background: #f8d7da; color: #721c24; }

        /* Estilos de votaci√≥n */
        .opcion-voto { display: block; padding: 15px; border: 2px solid #eee; margin-bottom: 10px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .opcion-voto:hover { border-color: #3498db; background: #fbfdff; }
        input[type="radio"] { transform: scale(1.5); margin-right: 10px; }
        .btn-votar { width: 100%; padding: 15px; background: #27ae60; color: white; font-size: 1.2em; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px; }

        /* Estilos del Panel Presidente */
        .panel-presidente { background-color: #f8f9fa; border: 2px solid #2c3e50; border-radius: 10px; padding: 20px; margin-bottom: 30px; }
        .grid-graficas { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        @media (max-width: 600px) { .grid-graficas { grid-template-columns: 1fr; } }
        
        .barra-fondo { background: #eee; border-radius: 5px; height: 25px; width: 100%; margin-top: 5px; overflow: hidden; }
        .barra-progreso { height: 100%; background: #3498db; text-align: right; padding-right: 5px; line-height: 25px; color: white; font-size: 0.8em; }
    </style>
</head>
<body>

    <div class="container">
        <a href="{% url 'listar_votaciones' %}" style="text-decoration: none; color: #7f8c8d;">‚¨Ö Volver a la lista</a>
        
        <div style="margin-top: 20px;">
            <span class="estado-box {% if votacion.activa %}activa{% else %}cerrada{% endif %}">
                {% if votacion.activa %}üü¢ Votaci√≥n Activa{% else %}üî¥ Finalizada{% endif %}
            </span>
            <h1 style="margin-top: 0;">{{ votacion.titulo }}</h1>
            <p style="color: #666; font-size: 1.1em;">{{ votacion.descripcion }}</p>
            <p style="font-size: 0.9em; color: #999;">Cierre el: {{ votacion.fecha_fin }}</p>
        </div>

        <hr style="margin: 30px 0;">

        {% if user.es_presidente %}
            <div class="panel-presidente">
                <h2 style="color: #2c3e50; margin-top: 0;">üìä Panel de Control (Vista Presidente)</h2>
                <p>Estad√≠sticas en tiempo real (visibles solo para ti).</p>

                <div class="grid-graficas">
                    <div style="background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <h4 style="text-align: center;">Resultados Actuales</h4>
                        <canvas id="graficaResultados"></canvas>
                    </div>

                    <div style="background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <h4 style="text-align: center;">Participaci√≥n ({{ total_votos }}/{{ total_vecinos }})</h4>
                        <canvas id="graficaParticipacion"></canvas>
                    </div>
                </div>
            </div>
        {% endif %}

        {% if votacion.activa and not ya_voto %}
            <h2>üó≥Ô∏è Emitir tu voto</h2>
            {% if opciones %}
                <form method="post">
                    {% csrf_token %}
                    {% for opcion in opciones %}
                        <label class="opcion-voto">
                            <input type="radio" name="opcion_seleccionada" value="{{ opcion.id }}" required>
                            {{ opcion.texto }}
                        </label>
                    {% endfor %}
                    <button type="submit" name="btn_votar" class="btn-votar">CONFIRMAR VOTO</button>
                </form>
            {% else %}
                <p style="color: red;">Error: No hay opciones disponibles.</p>
            {% endif %}

        {% else %}
            <h2>üìä Resultados P√∫blicos</h2>
            {% if ya_voto %}
                <p style="color: green;">‚úî Tu voto ya est√° registrado.</p>
            {% endif %}

            {% for dato in datos_grafica %}
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between;">
                        <strong>{{ dato.texto }}</strong>
                        <span>{{ dato.votos }} votos ({{ dato.porcentaje }}%)</span>
                    </div>
                    <div class="barra-fondo">
                        <div class="barra-progreso" style="width: {{ dato.porcentaje|floatformat:1 }}%;"></div>
                    </div>
                </div>
            {% empty %}
                <p>A√∫n no hay votos.</p>
            {% endfor %}
        {% endif %}

    </div>

    {% if user.es_presidente %}
    <script>
        // 1. Gr√°fica de Barras (Resultados)
        const ctx1 = document.getElementById('graficaResultados');
        new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: {{ nombres_js|safe }}, // Los nombres de las opciones desde Django
                datasets: [{
                    label: 'Votos',
                    data: {{ votos_js|safe }}, // Los n√∫meros de votos desde Django
                    backgroundColor: ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6'],
                    borderWidth: 1
                }]
            },
            options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });

        // 2. Gr√°fica de Donut (Participaci√≥n)
        const ctx2 = document.getElementById('graficaParticipacion');
        new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['Han Votado', 'Pendientes (Abstenci√≥n)'],
                datasets: [{
                    data: [{{ total_votos }}, {{ abstencion }}],
                    backgroundColor: ['#27ae60', '#ecf0f1'],
                    hoverOffset: 4
                }]
            }
        });
    </script>
    {% endif %}

</body>
</html>