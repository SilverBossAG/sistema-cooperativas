<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sala de Votaci√≥n</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: sans-serif; background-color: #f4f7f6; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .estado-box { float: right; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9em; }
        .activa { background: #d4edda; color: #155724; }
        .cerrada { background: #f8d7da; color: #721c24; }

        /* Estilos de votaci√≥n */
        .opcion-voto { display: block; padding: 15px; border: 2px solid #eee; margin-bottom: 10px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .opcion-voto:hover { border-color: #3498db; background: #fbfdff; }
        input[type="radio"] { transform: scale(1.5); margin-right: 10px; }
        .btn-votar { width: 100%; padding: 15px; background: #27ae60; color: white; font-size: 1.2em; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px; }

        /* Estilos del Panel Presidente */
        .panel-presidente { background-color: #f8f9fa; border: 2px solid #2c3e50; border-radius: 10px; padding: 20px; margin-bottom: 30px; }
        .grid-graficas { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        @media (max-width: 600px) { .grid-graficas { grid-template-columns: 1fr; } }
        
        /* Modal de Detalles */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .btn-cerrar { float: right; cursor: pointer; color: #e74c3c; font-weight: bold; }
        .lista-nombres { list-style: none; padding: 0; }
        .lista-nombres li { padding: 5px 0; border-bottom: 1px solid #f0f0f0; }

        .barra-fondo { background: #eee; border-radius: 5px; height: 25px; width: 100%; margin-top: 5px; overflow: hidden; }
        .barra-progreso { height: 100%; background: #3498db; text-align: right; padding-right: 5px; line-height: 25px; color: white; font-size: 0.8em; }
    </style>
</head>
<body>

    <div class="container">
        <a href="{% url 'listar_votaciones' %}" style="text-decoration: none; color: #7f8c8d;">‚¨Ö Volver a la lista</a>
        
        {% if messages %}
            <div style="margin-top: 20px;">
                {% for message in messages %}
                    <div style="padding: 10px; border-radius: 5px; margin-bottom: 10px; 
                        {% if message.tags == 'success' %}background: #d4edda; color: #155724;{% else %}background: #f8d7da; color: #721c24;{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <div style="margin-top: 20px;">
            <span class="estado-box {% if votacion.activa %}activa{% else %}cerrada{% endif %}">
                {% if votacion.activa %}üü¢ Votaci√≥n Activa{% else %}üî¥ Finalizada{% endif %}
            </span>
            <h1 style="margin-top: 0;">{{ votacion.titulo }}</h1>
            <p style="color: #666; font-size: 1.1em;">{{ votacion.descripcion }}</p>
            <p style="font-size: 0.9em; color: #999;">Cierre el: {{ votacion.fecha_fin }}</p>
        </div>

        <hr style="margin: 30px 0;">

        {% if user.es_presidente %}
            <div class="panel-presidente">
                <h2 style="color: #2c3e50; margin-top: 0;">üìä Panel de Control</h2>
                
                {% if permiso_ver_detalles %}
                    <p style="font-size: 0.9em; color: #27ae60;">üîì <strong>Modo Transparente:</strong> Haz clic en las gr√°ficas para ver nombres.</p>
                {% else %}
                    <p style="font-size: 0.9em; color: #7f8c8d;">üîí <strong>Voto Secreto:</strong> Solo puedes ver las cantidades totales, no los nombres.</p>
                {% endif %}

                <div class="grid-graficas">
                    <div style="background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); {% if permiso_ver_detalles %}cursor: pointer;{% endif %}">
                        <h4 style="text-align: center;">Resultados</h4>
                        <canvas id="graficaResultados"></canvas>
                    </div>

                    <div style="background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); {% if permiso_ver_detalles %}cursor: pointer;{% endif %}">
                        <h4 style="text-align: center;">Participaci√≥n ({{ total_votos }}/{{ total_vecinos }})</h4>
                        <canvas id="graficaParticipacion"></canvas>
                    </div>
                </div>
            </div>
        {% endif %}

        {% if votacion.activa and not ya_voto %}
            <h2>üó≥Ô∏è Emitir tu voto</h2>
            {% if opciones %}
                <form method="post">
                    {% csrf_token %}
                    {% for opcion in opciones %}
                        <label class="opcion-voto">
                            <input type="radio" name="opcion_seleccionada" value="{{ opcion.id }}" required>
                            {{ opcion.texto }}
                        </label>
                    {% endfor %}
                    <button type="submit" name="btn_votar" class="btn-votar">CONFIRMAR VOTO</button>
                </form>
            {% else %}
                <p style="color: red;">Error: No hay opciones disponibles.</p>
            {% endif %}

        {% else %}
            <h2>üìä Resultados P√∫blicos</h2>
            {% if ya_voto %}
                <p style="color: green; font-weight: bold;">‚úî Tu voto ya est√° registrado.</p>
            {% endif %}

            {% for dato in datos_grafica %}
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between;">
                        <strong>{{ dato.texto }}</strong>
                        <span>{{ dato.votos }} votos ({{ dato.porcentaje }}%)</span>
                    </div>
                    <div class="barra-fondo">
                        <div class="barra-progreso" style="width: {{ dato.porcentaje|floatformat:1 }}%;"></div>
                    </div>
                </div>
            {% empty %}
                <p>A√∫n no hay votos registrados.</p>
            {% endfor %}
        {% endif %}

    </div>

    <div id="modalDetalles" class="modal-overlay" onclick="cerrarModal(event)">
        <div class="modal-content">
            <div class="modal-header">
                <span id="tituloModal">Detalle</span>
                <span class="btn-cerrar" onclick="document.getElementById('modalDetalles').style.display='none'">X</span>
            </div>
            <ul id="listaNombres" class="lista-nombres">
                </ul>
        </div>
    </div>

    {% if user.es_presidente %}
    <script>
        // RECIBIMOS LOS DATOS JSON LIMPIOS
        const mapaVotos = {{ mapa_votos_json|safe }};
        const listaAbstencion = {{ lista_abstencion_json|safe }};
        const listaParticipacion = {{ lista_participacion_json|safe }};
        const permisoVer = {{ permiso_ver_detalles|yesno:"true,false" }};
        
        // GR√ÅFICAS (Sin comillas, porque ya vienen como texto JSON desde Python)
        const labelsData = {{ nombres_js|safe }};
        const votosData = {{ votos_js|safe }};

        function mostrarNombres(titulo, lista) {
            document.getElementById('tituloModal').innerText = titulo + ' (' + lista.length + ')';
            const ul = document.getElementById('listaNombres');
            ul.innerHTML = '';
            if (lista.length === 0) {
                ul.innerHTML = '<li style="color:#999;">Nadie</li>';
            } else {
                lista.forEach(nombre => {
                    ul.innerHTML += `<li>üë§ ${nombre}</li>`;
                });
            }
            document.getElementById('modalDetalles').style.display = 'flex';
        }

        function cerrarModal(e) {
            if (e.target.id === 'modalDetalles') e.target.style.display = 'none';
        }

        // GR√ÅFICA 1
        new Chart(document.getElementById('graficaResultados'), {
            type: 'bar',
            data: {
                labels: labelsData, // <--- AQU√ç EST√Å LA CLAVE
                datasets: [{
                    label: 'Votos',
                    data: votosData, // <--- Y AQU√ç
                    backgroundColor: ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6'],
                    borderWidth: 1
                }]
            },
            options: {
                onClick: (e, els) => {
                    if (!permisoVer || !els.length) return;
                    const index = els[0].index;
                    const op = labelsData[index];
                    mostrarNombres('Votaron: ' + op, mapaVotos[op] || []);
                },
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });

        // GR√ÅFICA 2
        new Chart(document.getElementById('graficaParticipacion'), {
            type: 'doughnut',
            data: {
                labels: ['Han Votado', 'Pendientes'],
                datasets: [{
                    data: [{{ total_votos }}, {{ abstencion }}],
                    backgroundColor: ['#27ae60', '#ecf0f1']
                }]
            },
            options: {
                onClick: (e, els) => {
                    if (!permisoVer || !els.length) return;
                    if (els[0].index === 0) mostrarNombres('Han Votado', listaParticipacion);
                    else mostrarNombres('Pendientes', listaAbstencion);
                }
            }
        });
    </script>
    {% endif %}

</body>
</html>